\documentclass{article}

\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage[round]{natbib}
\usepackage{verbatim}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{times}
\usepackage{authblk}
\usepackage{pdflscape}
\usepackage{afterpage}
\usepackage{hyperref}
\usepackage{capt-of}
\usepackage{filecontents}

\begin{filecontents*}{missing-observations.txt}
Damped Bundle Adjustment Toolbox result file
   Project Name: Bundle Soln PhotoModeler Calibration Project
   Problems and suggestions:
      Project Problems:
         Structural rank: 417 (deficiency: 6)
            DMPERM suggests the following parameters have problems:
               OX-12/13
               OY-12/13
               OZ-12/13
               OX-59/60
               OY-59/60
               OZ-59/60
         Numerical rank: not tested.
      Problems related to the processing: (1)
         Bundle failed with code -4 (see below for details).
.
.
.
\end{filecontents*}

\begin{filecontents*}{1ray.txt}
Damped Bundle Adjustment Toolbox result file
   Project Name: Bundle Soln PhotoModeler Calibration Project
   Problems and suggestions:
      Project Problems:
         Structural rank: 422 (deficiency: 1)
            DMPERM suggests the following parameters have problems:
               OZ-87/88
         Numerical rank: not tested.
      Problems related to the processing: (1)
         Bundle failed with code -4 (see below for details).
.
.
.
\end{filecontents*}

\begin{filecontents*}{missing-datum.txt}
Damped Bundle Adjustment Toolbox result file
   Project Name: Bundle Soln PhotoModeler Calibration Project
   Problems and suggestions:
      Project Problems:
         Structural rank: ok.
         Numerical rank: 428 (deficiency: 7)
            Null-space suggest the following parameters are part of the problem:
               Vector 1 (eigenvalue 1.36254e-18):
                  (EX-21, -0.156)
                  (EX-9, -0.13)
                  (EX-13, -0.12)
                  (EX-10, -0.119)
                  (EX-11, -0.115)
                  (EX-12, -0.108)
                  (EX-14, -0.104)
               Vector 2 (eigenvalue -1.60532e-17):
                  (EX-21, 0.207)
                  (EY-21, 0.195)
                  (EY-1, 0.192)
                  (EY-2, 0.178)
                  (EX-13, 0.167)
                  (EY-15, 0.166)
                  (EY-3, 0.166)
                  (EY-4, 0.163)
                  (EY-16, 0.161)
                  (EX-14, 0.157)
                  (EX-15, 0.151)
                  (EX-11, 0.149)
                  (EY-18, 0.147)
                  (EX-12, 0.146)
                  (EX-16, 0.145)
                  (EY-20, 0.133)
                  (EY-17, 0.128)
               Vector 3 (eigenvalue 5.21745e-17):
                  (om-21, -0.16)
                  (EX-3, -0.155)
                  (EX-4, -0.151)
                  (EX-5, -0.147)
                  (EX-6, -0.136)
                  (EZ-7, 0.132)
                  (om-13, -0.129)
                  (EX-1, -0.129)
                  (om-15, -0.127)
                  (om-16, -0.125)
                  (EZ-8, 0.125)
                  (om-14, -0.125)
                  (EZ-9, 0.122)
                  (EX-2, -0.117)
                  (om-11, -0.116)
                  (EZ-10, 0.116)
                  (om-12, -0.114)
                  (om-18, -0.113)
                  (om-20, -0.113)
                  (EZ-11, 0.111)
                  (EX-7, -0.111)
                  (EZ-12, 0.11)
                  (om-19, -0.109)
                  (om-9, -0.108)
                  (EZ-5, 0.107)
                  (om-1, -0.106)
                  (om-17, -0.106)
                  (om-2, -0.105)
                  (om-10, -0.105)
               Vector 4 (eigenvalue -5.5516e-17):
                  (EZ-21, -0.174)
                  (EX-5, -0.13)
                  (EX-7, -0.129)
                  (EX-8, -0.12)
                  (EX-6, -0.119)
                  (EY-9, -0.114)
                  (EY-11, -0.111)
               Vector 5 (eigenvalue -1.45759e-16):
                  (EY-7, 0.158)
                  (EY-5, 0.154)
                  (EY-8, 0.153)
                  (EY-9, 0.151)
                  (om-4, -0.147)
                  (EY-19, 0.147)
                  (om-3, -0.144)
                  (EY-6, 0.143)
                  (EY-10, 0.143)
                  (EY-17, 0.133)
                  (EZ-3, -0.132)
                  (EZ-4, -0.129)
                  (om-17, -0.126)
                  (om-19, -0.126)
                  (om-18, -0.125)
                  (om-1, -0.124)
                  (om-9, -0.124)
                  (om-2, -0.124)
                  (EY-18, 0.121)
                  (om-10, -0.121)
                  (EY-20, 0.12)
                  (om-20, -0.12)
                  (om-5, -0.12)
                  (EZ-2, -0.118)
                  (EZ-1, -0.118)
                  (om-6, -0.116)
                  (ph-9, -0.114)
                  (ph-7, -0.113)
                  (ph-11, -0.112)
                  (EY-11, 0.112)
                  (ph-12, -0.111)
                  (ph-8, -0.11)
                  (ph-10, -0.109)
                  (ph-5, -0.108)
                  (om-11, -0.108)
                  (EY-12, 0.107)
                  (EZ-5, -0.106)
                  (ph-13, -0.106)
                  (om-7, -0.104)
                  (ph-19, -0.104)
                  (om-12, -0.104)
                  (ph-14, -0.104)
               Vector 6 (eigenvalue -1.54875e-16):
                  (om-21, 0.185)
                  (ph-9, -0.174)
                  (EZ-21, 0.174)
                  (ph-10, -0.169)
                  (ph-11, -0.167)
                  (ph-7, -0.167)
                  (ph-8, -0.165)
                  (ph-12, -0.164)
                  (EX-9, -0.152)
                  (EX-7, -0.151)
                  (EX-8, -0.151)
                  (EY-11, -0.148)
                  (EY-12, -0.146)
                  (EX-10, -0.146)
                  (EZ-15, 0.142)
                  (EZ-16, 0.137)
                  (EY-13, -0.136)
                  (ph-5, -0.135)
                  (EY-14, -0.133)
                  (EZ-13, 0.127)
                  (ph-13, -0.127)
                  (EZ-14, 0.126)
                  (ph-14, -0.124)
                  (ph-6, -0.123)
                  (ph-19, -0.12)
                  (EY-21, -0.117)
               Vector 7 (eigenvalue 1.9046e-16):
                  (ph-1, 0.194)
                  (ph-2, 0.194)
                  (ph-15, 0.173)
                  (EX-2, 0.173)
                  (om-5, -0.173)
                  (ph-16, 0.169)
                  (ph-4, 0.169)
                  (EX-1, 0.168)
                  (ph-3, 0.164)
                  (om-8, -0.163)
                  (om-7, -0.16)
                  (om-6, -0.16)
                  (ph-21, 0.157)
                  (EY-21, -0.138)
                  (EY-5, 0.138)
                  (EY-6, 0.132)
                  (om-3, -0.127)
                  (ph-20, 0.126)
                  (om-4, -0.125)
      Problems related to the processing: (1)
         Bundle failed with code -2 (see below for details).  
.
.
.
\end{filecontents*}

\begin{document}

\bibliographystyle{abbrvnat}

\newcommand{\dbatversion}{0.8.5.1}
\newcommand{\dbatdate}{Jan 13, 2019}

\title{DBAT --- The Damped Bundle Adjustment Toolbox for Matlab\\\Large v\dbatversion{}}

\author[1]{Niclas B{\"o}rlin}
\author[2]{Pierre Grussenmeyer}
\affil[1]{Department of Computing Science, Ume{\aa} University,
  Sweden, \texttt{niclas.borlin@cs.umu.se}}
\affil[2]{ICube Laboratory UMR 7357, Photogrammetry and Geomatics Group, INSA Strasbourg, France, \texttt{pierre.grussenmeyer@insa-strasbourg.fr}}
\date{\dbatdate}

\maketitle

\vfill
With contributions from:
\begin{itemize}
\item Arnaud Durand, ICube-SERTIT, University of Strasbourg, France.
\item Jan Hieronymus, TU Berlin, Germany.
\item Jean-Fran{\c{c}}ois Hullo, EDF, France.
\item Fabio Menna, Fondazione Bruno Kessler, Trento, Italy.
\item Arnadi Murtiyoso, ICube, INSA Strasbourg, France.
\item Kostas Naskou, University of Nottingham, UK.
\item Erica Nocerino, Fondazione Bruno Kessler, Trento, Italy.
\item Deni Suwardhi, Bandung Institute of Technology, Indonesia.
\end{itemize}
\newpage

\tableofcontents

\newpage

\section{Introduction}

\subsection{Purpose}

This purpose of the Damped Bundle Adjustment toolbox is to be a
high-level toolbox for photogrammetry in general and bundle adjustment
in particular. It is the hope of the authors that the high-level
nature of the code will inspire algorithm development. The code is
written in Matlab and is verified to work with Matlab version 9.5
(release R2018b). The intention is that at least the computation
routines will be Octave-compatible. This has however not been tested
yet.

\subsection{Contents}

\subsubsection{Code}
The toolbox currently includes routines for (Matlab function names within parentheses):
\begin{itemize}
\item File handling:
  \begin{itemize}
  \item Reading PhotoModeler-style text export files (\texttt{loadpm}), 
    and 2D/3D point table exports files (\texttt{loadpm2dtbl} and
    \texttt{loadpm3dtbl}, respectively).
  \item Reading PhotoScan native (.psz) files (\texttt{loadpsz}).
  \item Writing PhotoModeler-style text result files
    (\texttt{bundle\_result\_file}).
  \end{itemize}
\item Post-processing:
  \begin{itemize}
  \item Post-processing of PhotoScan projects (\texttt{ps\_postproc}).
    Includes object point filtering on low ray count and low
    intersection angles. For self-calibration post-processing,
    see the help text for \texttt{ps\_postproc}.
  \item As of version 0.7.0.0, DBAT supports both lens distortion
    models used by Photomodeler and Photoscan.
  \end{itemize}
\item Photogrammetric calculations, including:
  \begin{itemize}
  \item Spatial resection (\texttt{resect}).
  \item Forward intersection (\texttt{forwintersect}).
  \item Absolute orientation (\texttt{rigidbody}).
  \item Relative orientation based on the Nist{\'e}r 5-point algorithm
    \citep{Stewenius2006:Recent} will be added in the future.
  \end{itemize}
\item Bundle adjustment proper (\texttt{bundle}):
  \begin{itemize}
  \item With or without self-calibration.
  \item Works with fixed or weighted prior observations, e.g., control
    points.
  \item Works with prior observations of camera positions.
  \item Supports check points.
  \item What parameters that should be estimated are selectable at the
    parameter level, e.g. down to the coordinate level for 3D points.
  \item Estimated parameters can be block-invariant (the same for a
    whole block), image-variant (individual for each image), or
    anything inbetween. Parameter sets may be split-variant, e.g.,
    with some IO parameters block-invariant and some IO parameters
    image-variant.
  \item Uses either Classical Gauss-Markov, Gauss-Newton-Armijo,
    Levenberg-Marquardt, or Levenberg-Marquardt-Powell damping schemes
    \citep{Borlin2013:Bundle,Borlin2014:Camera,Borlin2016:External}.
  \item Posterior covariance calculations (\texttt{bundle\_cov}) from
    the bundle result, including correlations and significance levels,
    point and image quality statistics.
  \end{itemize}
\item Analysis of camera networks, including:
  \begin{itemize}
  \item Detection of structural rank deficiency (Matlab's
    \texttt{dmperm}, \texttt{sprank}). Useful as a sanity check on
    input data. Structural rank deficiency is typically caused by
    trying to estimate a parameter with too few direct observations.
  \item Null-space analysis if the normal matrix is singular using
    \texttt{spnrank} \citep{Foster2009:Calculating}. This might, e.g.
    be caused by insufficient datum specification.
  \end{itemize}
  The result of the analysis, including suggestions for what
  parameters may be impossible to estimate are written to the report
  file by \texttt{bundle\_result\_file}.
\item Various plotting functions, including:
  \begin{itemize}
  \item Plot image covered by measurements
    (\texttt{plotcoverage}).
  \item Plot camera network (\texttt{plotnetwork}), either static
    (as-loaded) or as an illustration of the bundle iterations.
  \item Plot .psz project (\texttt{loadplotpsz}).
  \item Plot of the iteration trace of parameters estimated by bundle
    (\texttt{plotparams}).
  \item Plots of quality statistics from the bundle result
    (\texttt{plotimagestats, plotopstats}).
  \end{itemize}
\item Demo functions using the above functions. The demo functions are
  detailed in Section~\ref{sec:demos}. The available demos are listed
  by executing the command \texttt{help dbatdemos}.
\end{itemize}

This manual does not contain detailed information about how to use
each function. More information may be found by typing \texttt{help
  <function name>} at the Matlab prompt, studying the source code of
the demo functions, and reading the source code of each file directly.

\subsubsection{Data}

The toolbox contains several datasets, including datasets for the
\citet{Borlin2016:External,Murtiyoso2017:Reprocessing} papers.
\begin{itemize}
\item PhotoModeler export files or PhotoScan projects.
\item Images. To reduce the size of the distribution package, only low
  resolution images are included in the package\footnote{No images are
    included in the StPierre data set.}. The corresponding high
  resolution images can be downloaded from
  \url{http://www.cs.umu.se/~niclas/dbat_images}. Further instructions
  are found in \texttt{README.txt} files in the respective image
  directories.
\end{itemize}
The simplest way to access the data sets is through the demos,
described in Section~\ref{sec:demos}.

\subsection{Legal}

The licence detail are described in the \texttt{LICENSE.txt} file
included in the distribution. In summary:
\begin{itemize}
\item You use the code at your own risk.
\item You may use the code for any purpose, including commercial, as
  long as you give due credit. Specifically, if you use the code, or
  derivatives thereof, for scientific publications, you should refer
  to on or more of the papers
  \citet{Borlin2013:Bundle,Borlin2013:Experiments,Borlin2014:Camera,Borlin2016:External,Borlin2018:Modular}
  that the code is based on.
\item You may modify and redistribute the code as long as the
  licensing details are also redistributed.
\end{itemize}

\newpage
\section[Installation]{Installation (from INSTALL.txt)}
\label{sec:install}
\label{step:dbatInit}

{\footnotesize
\verbatiminput{../../INSTALL.txt}
}

\newpage
\section{Usage}

\subsection{Demos}
\label{sec:demos}

\textbf{Hint: You may wish to use the command \texttt{close all}
  between the demos to close all windows.}

A summary of the demos is found in Table~\ref{tab:demos}.

\subsubsection{Plotting}
\label{sec:loadplotdemo}
\label{sec:loadroma}

The \verb+loadplotdemo+ function load and plots the content of a
PhotoModeler text export file. Two examples are included in the
toolbox: {\sc Roma} and {\sc Cam}.

\paragraph{\sc Roma}
\verb+loadplotdemo('roma')+ loads a modified PhotoModeler text export
file of the 60-camera, 26000-point project used
in~\citet{Borlin2013:Bundle}. The camera network, as computed by
PhotoModeler, is plotted with camera 1 aligned to the cardinal axes.
The result should look like Figure~\ref{fig:roma}. The figure is a
standard Matlab 3D figure and may e.g.\ be rotated or zoomed using the
camera toolbar.

\begin{figure*}
  \centering
  \includegraphics[width=0.5\hsize]{ill/roma}
  \caption{The figure generated by the \texttt{loadplotdemo} demo.}
  \label{fig:roma}
\end{figure*}

\paragraph{\sc Cam}
\label{sec:camcaldata}
\verb+loadplotdemo('cam')+ demo loads a modified PhotoModeler text
export file of a 21-camera, 100-point camera calibration project. The
camera network, as computed by PhotoModeler, is plotted and should
look like Figure~\ref{fig:camcalib}. The figure is a standard Matlab
3D figure and may e.g.\ be rotated or zoomed using the camera toolbar.

\begin{figure*}
  \centering
  \includegraphics[width=0.45\hsize]{ill/ccam}
  \caption{The figure generated by the \texttt{loadplotdemo('cam')} demo.}
  \label{fig:camcalib}
\end{figure*}

\subsubsection{Camera calibration}

The \verb+camcaldemo+ demo loads the camera calibration export file
from Section~\ref{sec:camcaldata} and runs a camera calibration. The
EXIF focal length is used as the initial value. The other values are
set to ``default'' values, e.g.\ the principal point at the center of
the sensor and all lens distortion parameters equal to zero. The
initial value for the EO parameters are computed by spatial
resection~\citep[Chap.~11.1.3.4]{Haralick1994:Review,McGlone2004:Manual} using
the control points defined for the PhotoModeler calibration sheet. The
initial OP coordinates are subsequently computed by forward
intersection.

The bundle adjustment is run with Gauss-Newton-Armijo damping
\citep{Borlin2013:Bundle}. The result is given in a number of plot
windows and a Photo\-modeler-style result text file. The result plots
are of two kinds: Plots that show the evolution of the iterations and
plots that show the quality of the input or output data. The former
plots may be useful to understand how the bundle adjustment works but
also to ``debug'' a difficult network that has convergence
difficulties. The latter plots give information about the quality of
the result and may also provide clues on how to improve a network when
the bundle did converge.

\paragraph{Evolution plots}

\begin{figure*}
  \centering
  \begin{subfigure}[b]{0.7\textwidth}
    \includegraphics[width=\textwidth]{ill/ccamx0}
    \caption{Initial network configuration.}
    \label{fig:camx0}
  \end{subfigure}%

  \begin{subfigure}[b]{0.7\textwidth}
    \includegraphics[width=\textwidth]{ill/ccamxfinal}
    \caption{Network configuration after convergence, with camera
      center trace lines.}
    \label{fig:camxfinal}
  \end{subfigure}
  \caption{3D network evolution during the iterations. Only the EO and
    OP parameters are illustrated. In this example, the variation of
    the OP coordinates is barely visible. }\label{fig:net3DTrace}
\end{figure*}

The evolution plots are collected in
figures~\ref{fig:net3DTrace}--\ref{fig:gnatrace}.
Figure~\ref{fig:net3DTrace} shows a snapshot of the 3D trace figure at
the beginning and end of the iterations. As default, the evolution is
presented iteration by iteration with intervening presses of the
return key. The figure window is interactive and may be rotated,
zoomed, etc. In this example, it is clear in
Figure~\ref{fig:camxfinal} that one camera station had poorer initial
values than the rest.

\begin{figure*}
  \centering
  \includegraphics[width=0.7\textwidth]{ill/ccamiotrace}
  \caption{Evolution of IO parameters during the iteration sequence.}
  \label{fig:IOtrace}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=0.7\textwidth]{ill/ccameotrace}
  \caption{Evolution of EO parameters during the iteration sequence.}
  \label{fig:EOtrace}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=0.7\textwidth]{ill/ccamoptrace}
    \caption{Evolution of OP coordinates during the iteration
      sequence.}
    \label{fig:OPtrace}
\end{figure*}

Figures~\ref{fig:IOtrace}--\ref{fig:OPtrace} contain three plots
showing the evolution of the internal orientation (IO), external
orientation (EO), and object point (OP), respectively, during the
iterations. The IO plot is split into a focal/principal point panel
and a radial and tangential distortion panel, where the radial
distortion parameters are scaled to provide more information. The EO
plot contains a camera center panel and an $\omega$-$\phi$-$\kappa$
Euler angle panel. The EO and OP plots are interactive. Lines in the
plots or legends may be selected and all corresponding lines will be
highlighted. In the top panel of Figure~\ref{fig:EOtrace}, the motion
of one camera stands out. Clicking that line reveals that it belongs
to camera station~21, which can be further investigated to decide if
it should be excluded from the calibration.

\begin{figure*}
  \centering
  \includegraphics[width=0.7\textwidth]{ill/ccamgnatrace}
  \caption{Residual evolution and damping behaviour during the
    iterations.}
  \label{fig:gnatrace}
\end{figure*}

The final evolution plot, shown in Figure~\ref{fig:gnatrace},
illustrates the evolution of the norm of the total residual and the
damping behaviour, if any, during the bundle iterations. In this
example, the Gauss-Newton-Armijo linesearch damping is active during
the first two iterations. For further details on the damping,
see~\citet{Borlin2013:Bundle}.

\paragraph{Quality plots}

\begin{figure*}
  \centering
  \includegraphics[width=0.7\textwidth]{ill/ccamcoverage}
  \caption{Plots of input/output statistics: Image coverage.}
  \label{fig:ccamCoverage}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=0.7\textwidth]{ill/ccamimstats}
  \caption{Plots of input/output statistics: Image statistics.}
  \label{fig:ccamImstats}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=0.7\textwidth]{ill/ccamopstats}
  \caption{Plots of input/output statistics: Object point statistics.}
  \label{fig:ccamOPstats}
\end{figure*}

The quality plots a gathered in
figures~\ref{fig:ccamCoverage}--\ref{fig:ccamOPstats}. Per-image
quality statistics is shown in Figure~\ref{fig:ccamImstats}. The
statistics presented for each image are the image coverage
(rectangular coverage, convex hull coverage, and radial coverage); the
number of measured points; the average (RMS) point residual; and the
standard deviations for the EO parameters for the camera stations. In
this example, the data does not give any obvious support to exclude
the suspected image~21 from the calibration.

The image coverage is detailed in a separate
Figure~\ref{fig:ccamCoverage}. The plotted data is selectable. All
observations from a specific image, including their convex hull, will
be highlighted when a point or line is selected.

Finally, the per-OP quality statistics in Figure~\ref{fig:ccamOPstats}
show the number of observations per OP; the maximum ray intersection
angle; the average (RMS) point residual; and the OP coordinate
standard deviation. The presentation may be zoomed to show only a
subset of the OPs by activating the ``zoom'' function of the figure
window.

\paragraph{Result file}

The result file is modelled after the PhotoModeler result file.
The result file is listed in Appendix~\ref{sec:resultFile}.

\subsubsection{Lens distortion models}

The \texttt{camcaldemo\_allmodels} demo calibrates the camera using
each of the available lens distortion models. A result file is
generate for each model.

\newpage

\subsubsection{Bundle adjustment}

\paragraph{\sc Roma}
The \texttt{romabundledemo} function loads the project from
Section~\ref{sec:loadroma} and present essentially the same plots and
the \texttt{camcaldemo}. This demo uses the PhotoModeler file as input
to the bundle adjustment that runs a few iterations until convergence.
The same result file and result plots as \texttt{camcaldemo} are
essentially generated. Since the project is larger (60 cams/26~000
points) than the previous example (20 cams/100 points), the
computation will take a bit longer. Computation time was around one
minute running on a HP compaq dc7800 with an Intel Core2 Quad CPU
Q9300 @ 2.50GHz under 64-bit Ubuntu 12.04 (kernel 3.5.0-45). Two
variants with self-calibration (\texttt{romabundledemo\_selfcal}) and
image-variant self-calibration (\texttt{romabundledemo\_imagevariant})
are also included. In the latter, the principal point is image-variant
whereas the other IO parameters are block-invariant.

\paragraph{\sc Prague'16}
The \texttt{prague2016\_pm} function displays six projects that
compare the result of the bundle adjustment procedure in DBAT and the
results of PhotoModeler \citep{Borlin2016:External}. Similarily, the
\texttt{prague2016\_ps} function displays the results of a comparison
between DBAT and PhotoScan.

The v0.5.1.6 release includes a fix to a bug the distributed the image
observation weights incorrectly. The result is slightly different
estimation results than in \citet{Borlin2016:External}. However, the
conclusions remain valid.

\paragraph{\sc Hamburg'17}
The \texttt{stpierrebundledemo\_ps} function runs a self-calibration
bundle on a Photoscan project included in the StPierre data set.

\paragraph{\sc Prior camera observations}
The \texttt{sxb\_prior\_eo} demo shows how to include prior
observations of the camera positions in the bundle.

\subsubsection{Error detection}

Three demos are included to illustrate the error detection
capabilities of \texttt{sprank} (\texttt{dmperm}) and
\texttt{spnrank}. All are modelled from \texttt{camcaldemo}.

\paragraph{Missing observations}

The \texttt{camcaldemo\_missing\_obs} demo contains a data file where
the image observations of two object points (id 13 and 60,
respectively) have been deleted. With no observations of either point,
the rank deficiency detected by \texttt{sprank} is six. In the
generated result file (Section~\ref{sec:missingObsResultFile}), the
X/Y/Z coordinates of both points number 12 and 59 (with id 13 and 60,
respectively) are indeed listed as suspicious.

\paragraph{Single-ray observations}

The \texttt{camcaldemo\_1ray} demo contains a data file that contains
only one observation of object point with id 88. Since two
observations (one 2D point) is present but three parameter (one 3D
point) is to be estimated, the rank deficiency is one, the rank
deficiency detected by \texttt{sprank} is one. The generated result
file (Section~\ref{sec:singleRayResultFile}) lists one coordinate of
point 87 (with id 88) as suspicious.

\paragraph{Missing datum}

The \texttt{camcaldemo\_no\_datum} demo contains a demo where no datum
has been specified. As in the previous problems, the result is a
numerical problem with a singular (rank deficient) normal matrix.
However, in this case the problem is manifested by that many or all
parameters are linearly dependent of each other. This will not be
detected by \texttt{sprank}. In such a case, the null-space of the
normal matrix will carry information about what parameters are
linearly dependent, i.e. what parameters are part of the problem.
However, when the normal matrix is large, computing the null-space of
the normal matrix in the conventional way using the Matlab function
\texttt{null} will be intractable. Instead, the \texttt{spnrank}
\citep{Foster2009:Calculating} function is used to estimate the rank
deficiency of the normal matrix, i.e. the dimension of the null-space.
Given the dimension of the null-space, a basis for the null-space is
found using Matlab's \texttt{eigs} function. For this demo, the
generated result file (Section~\ref{sec:missingDatumResultFile}) lists
many EO parameters as suspicious. The cause of the problem is less
straight-forward to determine from the list. However, the listed rank
deficiency of seven should be a strong hint of a datum problem.

\afterpage{%
    \clearpage% Flush earlier floats (otherwise order might not be correct)
    \thispagestyle{empty}% empty page style (?)
    \begin{landscape}% Landscape page
        \centering % Center table
\begin{tabular}{llll}
Demo & Description & Datum & Self-calibration\\
\hline
\texttt{loadplotdemo} & Load and plot & - & -\\
\hline
\texttt{romabundledemo} & Bundle adjustment & Relative dependent orientation & no\\
\texttt{romabundledemo\_selfcal} & Bundle adjustment & Relative dependent orientation & yes\\
\texttt{romabundledemo\_imagevariant} & Bundle adjustment & Relative dependent orientation & yes, split-variant\\
\hline
\texttt{camcaldemo} & Camera calibration & Hard-coded control pts & yes\\
\texttt{camcaldemo\_allmodels} & Camera calibration, varying distorion models & Hard-coded control pts & yes\\
\texttt{camcaldemo\_missing\_obs} & Exact singular normal matrix & Hard-coded control pts & yes\\
\texttt{camcaldemo\_1ray} & Exact singular normal matrix & Hard-coded control pts & yes\\
\texttt{camcaldemo\_no\_datum} & Numerically singular normal matrix & Missing & yes\\
\hline
\texttt{prague2016\_pm('c1')} & Camera calibration & Hard-coded fixed control points & yes\\
\texttt{prague2016\_pm('c2')} & Camera calibration & Hard-coded weighted control points & yes\\
\texttt{prague2016\_pm('s1')} & Bundle adjustment & Fixed ctrl pts from text file & no\\
\texttt{prague2016\_pm('s2')} & Bundle adjustment & Weighted ctrl pts from text file & no\\
\texttt{prague2016\_pm('s4')} & Bundle adjustment & Weighted ctrl pts from text file & no\\
\hline
\texttt{prague2016\_ps('s5')} & Photoscan post-processing & Weighted ctrl pts from psz file & no\\
\hline
\texttt{ps\_postproc('')} & Photoscan post-processing & Weighted ctrl pts from psz file & no\\
\hline
\texttt{stpierrebundledemo\_ps} & Photoscan post-processing & Weighted ctrl pts from psz file & yes\\
\hline
\texttt{sxb\_prior\_eo} & Use of prior camera positions in bundle & Weighted ctrl pts, cam pos from text file & no\\
\end{tabular}
\captionof{table}{Summary of demos.}
\label{tab:demos}
    \end{landscape}
    \clearpage% Flush page
  }

\newpage
\subsection{Using your own data}

\subsubsection{Photoscan/Metashape}

DBAT can read native Photoscan Archive (\verb+.psz+) files. DBAT
cannot read Photoscan Project (\verb+.psx+) files. If you have a
\verb+.psx+ project, use the \verb+Save as...+ menu in Photoscan and
save the project as a Photoscan Archive (\verb+.psz+). DBAT has been
tested with Photoscan file versions up to v1.4.0, Photoscan program
version v1.4.4 as well as a pre-release v1.5.0 of Metashape.

The \verb+ps_postproc+ function can be used to post-process a
Photoscan project. \verb+loadplotpsz+ may be useful to visualize the
project, as computed by Photoscan. As of DBAT version 0.8.5.0, prior
observations of the camera positions are acknowledged and used in the
bundle.

\paragraph{Known limitations}

DBAT cannot handle all Photoscan coordinate systems. If you get
strange results, you may have to convert to Local Coordinates. \verb+loadplotpsz+ may be useful for debugging the input.

\subsubsection{PhotoModeler}

This section describes how to import you own data using PhotoModeler
text export files. If you have another type of input file, you may be
able to write your own loader. Otherwise, if you have a text file you
wish to import, feel free to mail the file to the the toolbox authors
and request an import function. Althought we cannot guarantee
anything, we may adhere to the request, time permitting.

\paragraph{Export from PhotoModeler}

To import a PhotoModeler project into the toolbox, the following
steps are valid in PhotoModeler Scanner 2012:

\begin{enumerate}
\item Export the project using the \emph{Export Text File} menu
  command. If the command is not available, follow the instructions in
  Appendix~\ref{sec:enableTextExport}.
\item After export, open the \emph{Project/Cameras...} dialog and
  select the camera that was used in your project.
\item Open the generated text file in a text editor.
  \begin{enumerate}
  \item On the 2nd line (usually reading \texttt{0.00005 20}), append
    the width and height in pixels of your images, e.g. to
    \texttt{0.000500 20 5616 3744}.
  \item Inspect the 4th line. For instance,
    the original data in \texttt{roma.txt} was (some trailing zeros removed):

    \texttt{24.3581 18.1143 12.0 35.96404 24.0 0.00022 -0.0 0.0 0.0 0.0}

    The values correspond to the following camera parameters:

    \texttt{focal pp\_x pp\_y format\_w format\_h K1 K2 K3 P1 P2}.

    Notice that most of the significant digits of K1--K3 were lost in
    the text export.
  \item Update the parameter values on the 4th line with values from
    the camera dialog \emph{for each parameter with a larger number of
      significant digits in the dialog}. This usually means all
    parameters except \texttt{format\_w}. In the \texttt{roma.txt}
    test case, the 4th line was modified to:

    \texttt{24.3581 18.1143 12 35.96404 24 2.174e-4 -1.518e-7 0 0 0}.

  \end{enumerate}
\end{enumerate}

\paragraph{Loading into Matlab}

\begin{enumerate}
\item In Matlab, run step~\ref{step:dbatInit} from
  Section~\ref{sec:install} if not already done.
\item Call \texttt{loadplotdemo} with the name of your text export
  file as first parameter. A figure with your camera network, aligned
  with the first camera and rotated to have +Z 'up', should now have
  been generated.
\end{enumerate}

\paragraph{Using the bundle adjustment of DBAT}

Modify either of the demo functions to match what you want to do. If
you run into any problems, send us an email. The interesting results
may either be in the plots or in the result file.

\newpage

\bibliography{ref}

\newpage

\appendix

\section{Appendices}

\subsection{Enabling text export from PhotoModeler}
\label{sec:enableTextExport}

Some versions of PhotoModeler do not have the text file export option
enabled by default. In that case, the following steps worked in
PhotoModeler Scanner 2012:
\begin{enumerate}
\item Right-click on the main window toolbar, select \emph{Customize toolbar...}.
\item In the \emph{Commands} tab, select the \emph{File} category.
\item Drag the \emph{Export Text File...} command to a toolbar of
  your choice.
\item Now you should be able to export your project as a text file by
  clicking on the \emph{Export Text File} button.
\end{enumerate}


\subsection{Rotation model}

Currently, the only supported rotation model is the omega-phi-kappa
Euler angle rotation model \citep[Ch.~2.1.2.3]{McGlone2004:Manual}.

\subsection{Result file with missing observations}
\label{sec:missingObsResultFile}

\scriptsize

\verbatiminput{missing-observations.txt}

\subsection{Result file with single-ray observations}
\label{sec:singleRayResultFile}

\scriptsize

\verbatiminput{1ray.txt}

\subsection{Result file with missing datum}
\label{sec:missingDatumResultFile}

\scriptsize

\verbatiminput{missing-datum.txt}

\subsection{Successful result file example}
\label{sec:resultFile}

\scriptsize
\verbatiminput{ill/camcal-dbatreport.txt}

\end{document}
